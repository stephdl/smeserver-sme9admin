{
	use MIME::Base64 qw(encode_base64);

	my $sme9admindb = $DB->get('sme9admind') || $DB->new_record("sme9admind",{type=>'service'});

	$pw = "not set due to error";

	if ( open( RANDOM, "/dev/urandom" ) ){
		my $buf;
          	if ( read( RANDOM, $buf, 25 ) != 25 ){
              		warn("Short read from /dev/random: $!");
          	}
          	else{
              		$pw = encode_base64($buf);
              		chomp $pw;
          	}
          	close RANDOM;
        }
      	else{
          	warn "Could not open /dev/urandom: $!";
        }

	$sme9admindb->set_prop('DbPassword', $pw) if not $sme9admindb->prop('DbPassword');

	if ( -e "/etc/e-smith/web/panels/manager/html/sme9admin/_sme9admin.conf" ){
		open(CONF,"</etc/e-smith/web/panels/manager/html/sme9admin/_sme9admin.conf");
		my @confs = <CONF>;
		close(CONF);
		foreach (@confs){
    			foreach my $key (qw(
				db_database
				db_password
				db_username
				img_format
				img_width
				img_height
				other_mail_address_domains
				ping_target
				hddtemp_first_hd
				hddtemp_second_hd
				du_enabled
				sensors_first_temp_tag
				sensors_second_temp_tag
				sensors_fan_tag
				limit_pppoe_disconnection
				limit_pppoe_duration
				limit_vpn_duration
				mail_alert_recipient
				mail_status_recipient
				mail_status_delay_between
				max_mail_in
				max_mail_out
				max_hd_used
				max_cpu_total
				max_temp_hard
				max_temp_hd
				max_sessions_samba
				max_sessions_ssh
				max_sessions_ftp
				max_sessions_vpn
				)){
	            		# valeur = partie droite de la ligne contenant $key dans le fichier
          			if ($_ =~ /\s*$key\s*=\s*(.*)/){
         				$params{$key} = $1;
           			}
       			}
		}
		# Si la valeur dans la db est difÃ©rente de la valeur trouve dans le fichier, alors on met a jour la db
		$sme9admindb->set_prop('DbName',$params{'db_database'}); 
#			if ($sme9admindb->prop('DbName') ne $params{'db_database'});
		$sme9admindb->set_prop('DbPassword',$params{'db_password'});
#                       if ($sme9admindb->prop('DbPassword') ne $params{'db_password'});
		$sme9admindb->set_prop('DbUser',$params{'db_username'});
#			if ($sme9admindb->prop('DbUser') ne $params{'db_username'});
		$sme9admindb->set_prop('ImgFormat',$params{'img_format'}); 
#			if ($sme9admindb->prop('ImgFormat') ne $params{'img_format'});
		$sme9admindb->set_prop('ImgWidth',$params{'img_width'});
#			if ($sme9admindb->prop('ImgWidth') ne $params{'img_width'});
		$sme9admindb->set_prop('ImgHeight',$params{'img_height'}); 
#			if ($sme9admindb->prop('ImgHeight') ne $params{'img_height'});
		$sme9admindb->set_prop('OtherMailDomains',$params{'other_mail_address_domains'});
#			if ($sme9admindb->prop('OtherMailDomains') ne $params{'other_mail_address_domains'});
		$sme9admindb->set_prop('PingTarget',$params{'ping_target'});
#			if ($sme9admindb->prop('PingTarget') ne $params{'ping_target'});
		$sme9admindb->set_prop('hd1',$params{'hddtemp_first_hd'});
#			if ($sme9admindb->prop('hd1') ne $params{'hddtemp_first_hd'});
		$sme9admindb->set_prop('hd2',$params{'hddtemp_second_hd'});
#			if ($sme9admindb->prop('hd2') ne $params{'hddtemp_second_hd'});
		$sme9admindb->set_prop('UseDu',$params{'du_enabled'});
#			if ($sme9admindb->prop('UseDu') ne $params{'du_enabled'});
		$sme9admindb->set_prop('SensorsTag1',$params{'sensors_first_temp_tag'});
#			if ($sme9admindb->prop('SensorsTag1') ne $params{'sensors_first_temp_tag'});
		$sme9admindb->set_prop('SensorsTag2',$params{'sensors_second_temp_tag'});
#			if ($sme9admindb->prop('SensorsTag2') ne $params{'sensors_second_temp_tag'});
		$sme9admindb->set_prop('SensorsTagFan',$params{'sensors_fan_tag'});
#			if ($sme9admindb->prop('SensorsTagFan') ne $params{'sensors_fan_tag'});
		$sme9admindb->set_prop('LimitPppoeDisconnect',$params{'limit_pppoe_disconnection'});
#			if ($sme9admindb->prop('LimitPppoeDisconnect') ne $params{'limit_pppoe_disconnection'});
		$sme9admindb->set_prop('LimitPppoeDuration',$params{'limit_pppoe_duration'});
#			if ($sme9admindb->prop('LimitPppoeDuration') ne $params{'limit_pppoe_duration'});
		$sme9admindb->set_prop('LimitVpnDuration',$params{'limit_vpn_duration'});
#			if ($sme9admindb->prop('LimitVpnDuration') ne $params{'limit_vpn_duration'});
		$sme9admindb->set_prop('AlertMailRecipient',$params{'mail_alert_recipient'});
#			if ($sme9admindb->prop('AlertMailRecipient') ne $params{'mail_alert_recipient'});
		$sme9admindb->set_prop('StatusMailRecipient',$params{'mail_status_recipient'});
#			if ($sme9admindb->prop('StatusMailRecipient') ne $params{'mail_status_recipient'});
		$sme9admindb->set_prop('StatusInterval',$params{'mail_status_delay_between'});
#			if ($sme9admindb->prop('StatusInterval') ne $params{'mail_status_delay_between'});
		$sme9admindb->set_prop('MaxMailIn',$params{'max_mail_in'});
#			if ($sme9admindb->prop('MaxMailIn') ne $params{'max_mail_in'});
		$sme9admindb->set_prop('MaxMailOut',$params{'max_mail_out'});
#			if ($sme9admindb->prop('MaxMailOut') ne $params{'max_mail_out'});
		$sme9admindb->set_prop('MaxDiskSpace',$params{'max_hd_used'});
#			if ($sme9admindb->prop('MaxDiskSpace') ne $params{'max_hd_used'});
		$sme9admindb->set_prop('MaxCpu',$params{'max_cpu_total'});
#			if ($sme9admindb->prop('MaxCpu') ne $params{'max_cpu_total'});
		$sme9admindb->set_prop('MaxHwTemp',$params{'max_temp_hard'});
#			if ($sme9admindb->prop('MaxHwTemp') ne $params{'max_temp_hard'});
		$sme9admindb->set_prop('MaxSamba',$params{'max_sessions_samba'});
#			if ($sme9admindb->prop('MaxSamba') ne $params{'max_sessions_samba'});
		$sme9admindb->set_prop('MaxSsh',$params{'max_sessions_ssh'});
#			if ($sme9admindb->prop('MaxSsh') ne $params{'max_sessions_ssh'});
		$sme9admindb->set_prop('MaxFtp',$params{'max_sessions_ftp'});
#			if ($sme9admindb->prop('MaxFtp') ne $params{'max_sessions_ftp'});
		$sme9admindb->set_prop('MaxVpn',$params{'max_sessions_vpn'});
#			if ($sme9admindb->prop('MaxVpn') ne $params{'max_sessions_vpn'});
		system("/bin/mv /etc/e-smith/web/panels/manager/html/sme9admin/_sme9admin.conf /etc/e-smith/web/panels/manager/html/sme9admin/sme9admin.conf.old");
	}
}

